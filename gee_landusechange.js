var fr =
  /* color: #bf04c2 */
  /* shown: false */
  /* displayProperties: [
    {
      "type": "polygon"
    },
    {
      "type": "polygon"
    },
    {
      "type": "polygon"
    },
    {
      "type": "polygon"
    },
    {
      "type": "polygon"
    },
    {
      "type": "polygon"
    },
    {
      "type": "polygon"
    },
    {
      "type": "polygon"
    },
    {
      "type": "polygon"
    },
    {
      "type": "polygon"
    },
    {
      "type": "polygon"
    },
    {
      "type": "polygon"
    },
    {
      "type": "rectangle"
    },
    {
      "type": "rectangle"
    },
    {
      "type": "rectangle"
    }
  ] */
  ee.Geometry.MultiPolygon(
    [[[[100.39995969665245, 17.738546955700468],
    [100.39995969665245, 17.737402451818554],
    [100.40133298766807, 17.737402451818554],
    [100.40133298766807, 17.738546955700468]]],
    [[[100.41163267028526, 17.738955705314584],
    [100.41163267028526, 17.73789295437767],
    [100.4129201306124, 17.73789295437767],
    [100.4129201306124, 17.738955705314584]]],
    [[[100.4206448925753, 17.741081188270748],
    [100.4206448925753, 17.740100199271538],
    [100.42167486083702, 17.740100199271538],
    [100.42167486083702, 17.741081188270748]]],
    [[[100.42665304076866, 17.743615384980203],
    [100.42665304076866, 17.742797906089173],
    [100.4279405010958, 17.742797906089173],
    [100.4279405010958, 17.743615384980203]]],
    [[[100.39472402465537, 17.733723639814738],
    [100.39472402465537, 17.732987868348978],
    [100.3957539929171, 17.732987868348978],
    [100.3957539929171, 17.733723639814738]]],
    [[[100.38931669128135, 17.738792205580875],
    [100.38931669128135, 17.737974704673615],
    [100.39129079711631, 17.737974704673615],
    [100.39129079711631, 17.738792205580875]]],
    [[[100.38983167541221, 17.745086837579127],
    [100.38983167541221, 17.74386062791976],
    [100.39266408813194, 17.74386062791976],
    [100.39266408813194, 17.745086837579127]]],
    [[[100.41266263854698, 17.75203520034251],
    [100.41266263854698, 17.7503185710991],
    [100.41523755920127, 17.7503185710991],
    [100.41523755920127, 17.75203520034251]]],
    [[[100.40699781310752, 17.746967009412923],
    [100.40699781310752, 17.745659065879607],
    [100.40888608825401, 17.745659065879607],
    [100.40888608825401, 17.746967009412923]]],
    [[[100.4015904797335, 17.756449314216493],
    [100.4015904797335, 17.755223182395913],
    [100.40373624694541, 17.755223182395913],
    [100.40373624694541, 17.756449314216493]]],
    [[[100.41231931579307, 17.735522179566146],
    [100.41231931579307, 17.73494991887645],
    [100.41309179198936, 17.73494991887645],
    [100.41309179198936, 17.735522179566146]]],
    [[[100.40493787658409, 17.7359718116828],
    [100.40493787658409, 17.735440428150966],
    [100.40549577605918, 17.735440428150966],
    [100.40549577605918, 17.7359718116828]]],
    [[[100.44863931944053, 17.629351989058556],
    [100.44863931944053, 17.62689798120011],
    [100.4520725469796, 17.62689798120011],
    [100.4520725469796, 17.629351989058556]]],
    [[[100.47129862119834, 17.644566092124382],
    [100.47129862119834, 17.642275879168324],
    [100.4740452032296, 17.642275879168324],
    [100.4740452032296, 17.644566092124382]]],
    [[[100.4842636950132, 17.81614469309208],
    [100.4842636950132, 17.81091488681041],
    [100.48615197015968, 17.81091488681041],
    [100.48615197015968, 17.81614469309208]]]], null, false),
  nfr =
    /* color: #ff0000 */
    /* shown: false */
    /* displayProperties: [
      {
        "type": "polygon"
      },
      {
        "type": "polygon"
      },
      {
        "type": "polygon"
      },
      {
        "type": "polygon"
      },
      {
        "type": "polygon"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      }
    ] */
    ee.Geometry.MultiPolygon(
      [[[[100.42666061572032, 17.73622035128526],
      [100.42666061572032, 17.735443714361526],
      [100.42756183794933, 17.735443714361526],
      [100.42756183794933, 17.73622035128526]]],
      [[[100.39013475212346, 17.71794850807348],
      [100.39013475212346, 17.71735575135572],
      [100.39075702461491, 17.71735575135572],
      [100.39075702461491, 17.71794850807348]]],
      [[[100.39508792738752, 17.71715263338823],
      [100.39508792738752, 17.716580314050137],
      [100.39583894591169, 17.716580314050137],
      [100.39583894591169, 17.71715263338823]]],
      [[[100.39069426078066, 17.726186231371614],
      [100.39069426078066, 17.72576723314613],
      [100.3911877872394, 17.72576723314613],
      [100.3911877872394, 17.726186231371614]]],
      [[[100.39375751638111, 17.72521134437546],
      [100.39375751638111, 17.724966075906494],
      [100.39451389932331, 17.724966075906494],
      [100.39451389932331, 17.72521134437546]]],
      [[[100.44915005188922, 17.742301724825783],
      [100.44915005188922, 17.74191341996928],
      [100.45007273179034, 17.74191341996928],
      [100.45007273179034, 17.742301724825783]]],
      [[[100.41419425493133, 17.72848956401716],
      [100.41419425493133, 17.72750850607042],
      [100.4156104612912, 17.72750850607042],
      [100.4156104612912, 17.72848956401716]]]], null, false),
  wtr =
    /* color: #00ff00 */
    /* shown: false */
    ee.Geometry.MultiPolygon(
      [[[[100.44884609959789, 17.71153056572745],
      [100.44884609959789, 17.71110131294169],
      [100.45028376362987, 17.71110131294169],
      [100.45028376362987, 17.71153056572745]]],
      [[[100.46081948064037, 17.709629581308036],
      [100.46081948064037, 17.708403129058436],
      [100.46227860234447, 17.708403129058436],
      [100.46227860234447, 17.709629581308036]]],
      [[[100.5048036654361, 17.787209254714668],
      [100.5048036654361, 17.77969014100302],
      [100.51132679776032, 17.77969014100302],
      [100.51132679776032, 17.787209254714668]]],
      [[[100.54085255459626, 17.785247777303912],
      [100.54085255459626, 17.780997835687245],
      [100.54600239590485, 17.780997835687245],
      [100.54600239590485, 17.785247777303912]]]], null, false);


var aoi = ee.Geometry.Polygon([
  [100.36764930688022, 17.608539690851376],
  [100.56631563611441, 17.608539690851376],
  [100.56631563611441, 17.834018594719918],
  [100.36764930688022, 17.834018594719918],
  [100.36764930688022, 17.608539690851376]
]);

var years = ee.List.sequence(1984, 2024, 2);  // Start from 1984 for Landsat 5

function setYear(image) {
  return image.set('year', ee.Date(image.date()).format('YYYY'));
}

function getLandsatCollection(year) {
  var startDate = ee.Date.fromYMD(year, 9, 1);
  var endDate = ee.Date.fromYMD(year, 12, 30);

  var collection;
  if (year >= 1984 && year <= 1999) {
    collection = ee.ImageCollection('LANDSAT/LT05/C02/T1_TOA');
  } else if (year >= 1999 && year <= 2012) {
    collection = ee.ImageCollection('LANDSAT/LE07/C02/T1_TOA');
  } else if (year >= 2013 && year <= 2021) {
    collection = ee.ImageCollection('LANDSAT/LC08/C02/T1_TOA');
  } else if (year >= 2021) {
    collection = ee.ImageCollection('LANDSAT/LC09/C02/T1_TOA');
  } else {
    return null;
  }

  return collection
    .filterBounds(aoi)
    .filterDate(startDate, endDate)
    .filter(ee.Filter.lte('CLOUD_COVER', 10))
}

function calculateNDVI(image, red, nir) {
  var img = image.select(['B3', 'B4', 'B5']).median().clip(aoi);
  var ndvi = img.normalizedDifference([nir, red]).rename('NDVI');
  return img.addBands(ndvi);
}

var trainingData = ee.FeatureCollection([
  ee.Feature(fr, { 'class': 0 }),
  ee.Feature(nfr, { 'class': 1 }),
  ee.Feature(wtr, { 'class': 2 })
  // Add more training points as needed
]);

var trainSVM = function (image) {

  var bands = image.bandNames();
  print(bands)
  var training = image.select(bands).sampleRegions({
    collection: trainingData,
    properties: ['class'],
    scale: 30
  });

  var rmf = ee.Classifier.smileRandomForest({
    numberOfTrees: 200
  });

  var libsvm = ee.Classifier.libsvm({
    kernelType: 'RBF',
    gamma: 0.5,
    cost: 100
  });

  var classifier = libsvm.train({
    features: training,
    classProperty: 'class',
    inputProperties: bands
  });

  return classifier;
};

var classifyImage = function (year, red, nir) {
  var data_all = getLandsatCollection(year);
  if (data_all === null) return null;

  var data_ndvi = calculateNDVI(data_all, red, nir);
  var classifier = trainSVM(data_ndvi);
  var classified = data_ndvi.classify(classifier);

  return classified.set('year', year);
};

var class2023 = classifyImage(2023, 'B4', 'B5');
var class2022 = classifyImage(2022, 'B4', 'B5');
var class2020 = classifyImage(2020, 'B4', 'B5');
var class2018 = classifyImage(2018, 'B4', 'B5');
var class2016 = classifyImage(2016, 'B4', 'B5');
var class2014 = classifyImage(2014, 'B4', 'B5');
var class2012 = classifyImage(2012, 'B3', 'B4');
var class2009 = classifyImage(2009, 'B3', 'B4');
var class2008 = classifyImage(2008, 'B3', 'B4');
var class2006 = classifyImage(2006, 'B3', 'B4');
var class2004 = classifyImage(2004, 'B3', 'B4');
var class2002 = classifyImage(2002, 'B3', 'B4');
var class2000 = classifyImage(2000, 'B3', 'B4');
var class1998 = classifyImage(1998, 'B3', 'B4');
var class1996 = classifyImage(1996, 'B3', 'B4');
var class1994 = classifyImage(1994, 'B3', 'B4');
var class1992 = classifyImage(1992, 'B3', 'B4');
var class1990 = classifyImage(1990, 'B3', 'B4');
var class1988 = classifyImage(1989, 'B3', 'B4');

var visualizationParams = {
  min: 0,
  max: 2,
  palette: ['green', 'brown', 'blue']
};

Map.centerObject(aoi, 12);
Map.addLayer(class2023, visualizationParams, 'landuse 2023');
Map.addLayer(class2022, visualizationParams, 'landuse 2022');
Map.addLayer(class2020, visualizationParams, 'landuse 2020');
Map.addLayer(class2018, visualizationParams, 'landuse 2018');
Map.addLayer(class2016, visualizationParams, 'landuse 2016');
Map.addLayer(class2014, visualizationParams, 'landuse 2014');
Map.addLayer(class2012, visualizationParams, 'landuse 2012');
Map.addLayer(class2009, visualizationParams, 'landuse 2009');
Map.addLayer(class2008, visualizationParams, 'landuse 2008');
Map.addLayer(class2006, visualizationParams, 'landuse 2006');
Map.addLayer(class2004, visualizationParams, 'landuse 2004');
Map.addLayer(class2002, visualizationParams, 'landuse 2002');
Map.addLayer(class2000, visualizationParams, 'landuse 2000');
Map.addLayer(class1998, visualizationParams, 'landuse 1998');
Map.addLayer(class1996, visualizationParams, 'landuse 1996');
Map.addLayer(class1994, visualizationParams, 'landuse 1994');
Map.addLayer(class1992, visualizationParams, 'landuse 1992');
Map.addLayer(class1990, visualizationParams, 'landuse 1990');
Map.addLayer(class1988, visualizationParams, 'landuse 1988');

var legend = ui.Panel({
  style: {
    position: 'bottom-left',
    padding: '8px 15px'
  }
});

var legendTitle = ui.Label({
  value: 'Classification Legend',
  style: {
    fontWeight: 'bold',
    fontSize: '18px',
    margin: '0 0 4px 0',
    padding: '0'
  }
});
legend.add(legendTitle);

var makeRow = function (color, name) {
  var colorBox = ui.Label({
    style: {
      backgroundColor: color,
      padding: '8px',
      margin: '0 0 4px 0'
    }
  });
  var description = ui.Label({
    value: name,
    style: { margin: '0 0 4px 6px' }
  });
  return ui.Panel({
    widgets: [colorBox, description],
    layout: ui.Panel.Layout.Flow('horizontal')
  });
};

var palette = visualizationParams.palette;
var names = ['ป่าไม้', 'ไม่ใช่ป่า', 'แหล่งน้ำ'];

for (var i = 0; i < 3; i++) {
  legend.add(makeRow(palette[i], names[i]));
}

Map.add(legend);